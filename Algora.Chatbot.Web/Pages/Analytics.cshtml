@page
@model Algora.Chatbot.Web.Pages.AnalyticsModel
@{
    ViewData["Title"] = "Analytics";
}

<div class="container-fluid py-4">
    <div class="row mb-4">
        <div class="col-12 d-flex justify-content-between align-items-center">
            <div>
                <h4 class="mb-0">Analytics</h4>
                <p class="text-muted mb-0">Track your chatbot performance over time</p>
            </div>
            <div class="d-flex gap-2">
                <select class="form-select form-select-sm" id="date-range" style="width: auto;">
                    <option value="7">Last 7 days</option>
                    <option value="14">Last 14 days</option>
                    <option value="30" selected>Last 30 days</option>
                    <option value="90">Last 90 days</option>
                </select>
            </div>
        </div>
    </div>

    <!-- Summary Cards -->
    <div class="row mb-4">
        <div class="col-xl-3 col-sm-6 mb-4">
            <div class="card">
                <div class="card-body p-3">
                    <p class="text-sm mb-0 text-uppercase font-weight-bold text-muted">Total Conversations</p>
                    <h4 class="font-weight-bolder mb-0" id="total-conversations">-</h4>
                    <p class="text-sm mb-0 text-muted">in selected period</p>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-sm-6 mb-4">
            <div class="card">
                <div class="card-body p-3">
                    <p class="text-sm mb-0 text-uppercase font-weight-bold text-muted">Resolved</p>
                    <h4 class="font-weight-bolder mb-0" id="total-resolved">-</h4>
                    <p class="text-sm mb-0 text-success">resolved without escalation</p>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-sm-6 mb-4">
            <div class="card">
                <div class="card-body p-3">
                    <p class="text-sm mb-0 text-uppercase font-weight-bold text-muted">Escalated</p>
                    <h4 class="font-weight-bolder mb-0" id="total-escalated">-</h4>
                    <p class="text-sm mb-0 text-warning">required human support</p>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-sm-6 mb-4">
            <div class="card">
                <div class="card-body p-3">
                    <p class="text-sm mb-0 text-uppercase font-weight-bold text-muted">AI Cost</p>
                    <h4 class="font-weight-bolder mb-0" id="total-cost">$-</h4>
                    <p class="text-sm mb-0 text-muted">estimated spend</p>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Conversations Over Time -->
        <div class="col-lg-8 mb-4">
            <div class="card h-100">
                <div class="card-header pb-0">
                    <h6>Conversations Over Time</h6>
                </div>
                <div class="card-body">
                    <canvas id="conversationsChart" height="250"></canvas>
                </div>
            </div>
        </div>

        <!-- Resolution Rate Trend -->
        <div class="col-lg-4 mb-4">
            <div class="card h-100">
                <div class="card-header pb-0">
                    <h6>Resolution Rate</h6>
                </div>
                <div class="card-body">
                    <canvas id="resolutionChart" height="250"></canvas>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Rating Distribution -->
        <div class="col-lg-4 mb-4">
            <div class="card h-100">
                <div class="card-header pb-0">
                    <h6>Customer Ratings</h6>
                </div>
                <div class="card-body">
                    <canvas id="ratingsChart" height="200"></canvas>
                </div>
            </div>
        </div>

        <!-- Intent Breakdown -->
        <div class="col-lg-4 mb-4">
            <div class="card h-100">
                <div class="card-header pb-0">
                    <h6>Intent Breakdown</h6>
                </div>
                <div class="card-body">
                    <canvas id="intentChart" height="200"></canvas>
                </div>
            </div>
        </div>

        <!-- AI Provider Usage -->
        <div class="col-lg-4 mb-4">
            <div class="card h-100">
                <div class="card-header pb-0">
                    <h6>Performance Metrics</h6>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <div class="d-flex justify-content-between mb-1">
                            <span class="text-sm">Avg Response Time</span>
                            <span class="text-sm font-weight-bold" id="avg-response-time">-</span>
                        </div>
                        <div class="progress" style="height: 6px;">
                            <div class="progress-bar bg-success" role="progressbar" id="response-time-bar"
                                 style="width: 0%"></div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <div class="d-flex justify-content-between mb-1">
                            <span class="text-sm">Helpful Rate</span>
                            <span class="text-sm font-weight-bold" id="helpful-rate">-</span>
                        </div>
                        <div class="progress" style="height: 6px;">
                            <div class="progress-bar bg-info" role="progressbar" id="helpful-bar"
                                 style="width: 0%"></div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <div class="d-flex justify-content-between mb-1">
                            <span class="text-sm">Avg Rating</span>
                            <span class="text-sm font-weight-bold" id="avg-rating">-</span>
                        </div>
                        <div class="progress" style="height: 6px;">
                            <div class="progress-bar bg-warning" role="progressbar" id="rating-bar"
                                 style="width: 0%"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Data Table -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header pb-0">
                    <h6>Daily Breakdown</h6>
                </div>
                <div class="card-body px-0 pt-0 pb-2">
                    <div class="table-responsive">
                        <table class="table align-items-center mb-0">
                            <thead>
                                <tr>
                                    <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Date</th>
                                    <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 ps-2">Conversations</th>
                                    <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 ps-2">Resolved</th>
                                    <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 ps-2">Escalated</th>
                                    <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 ps-2">Avg Rating</th>
                                    <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 ps-2">Helpful %</th>
                                    <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 ps-2">AI Cost</th>
                                </tr>
                            </thead>
                            <tbody id="analytics-table">
                                <tr>
                                    <td colspan="7" class="text-center text-muted py-4">Loading...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        const shop = new URLSearchParams(window.location.search).get('shop') || '@Model.ShopDomain';
        let conversationsChart, resolutionChart, ratingsChart, intentChart;

        async function loadAnalytics() {
            const days = parseInt(document.getElementById('date-range').value);
            const endDate = new Date();
            const startDate = new Date();
            startDate.setDate(startDate.getDate() - days);

            try {
                const response = await fetch(
                    `/api/admin/v1/analytics?shop=${encodeURIComponent(shop)}&startDate=${startDate.toISOString()}&endDate=${endDate.toISOString()}`
                );
                const result = await response.json();

                if (result.success && result.data) {
                    renderAnalytics(result.data);
                }
            } catch (error) {
                console.error('Failed to load analytics:', error);
            }
        }

        function renderAnalytics(data) {
            // Calculate totals
            const totalConversations = data.reduce((sum, d) => sum + d.totalConversations, 0);
            const totalResolved = data.reduce((sum, d) => sum + d.resolvedConversations, 0);
            const totalEscalated = data.reduce((sum, d) => sum + d.escalatedConversations, 0);
            const totalCost = data.reduce((sum, d) => sum + d.totalAiCost, 0);

            document.getElementById('total-conversations').textContent = totalConversations;
            document.getElementById('total-resolved').textContent = totalResolved;
            document.getElementById('total-escalated').textContent = totalEscalated;
            document.getElementById('total-cost').textContent = '$' + totalCost.toFixed(2);

            // Render charts
            renderConversationsChart(data);
            renderResolutionChart(data);
            renderTable(data);

            // Performance metrics
            const avgRatings = data.filter(d => d.avgRating > 0);
            const avgRating = avgRatings.length > 0
                ? avgRatings.reduce((sum, d) => sum + d.avgRating, 0) / avgRatings.length
                : 0;

            const avgHelpful = data.filter(d => d.helpfulPercentage > 0);
            const helpfulRate = avgHelpful.length > 0
                ? avgHelpful.reduce((sum, d) => sum + d.helpfulPercentage, 0) / avgHelpful.length
                : 0;

            const avgResponse = data.filter(d => d.avgResponseTimeSeconds > 0);
            const responseTime = avgResponse.length > 0
                ? avgResponse.reduce((sum, d) => sum + d.avgResponseTimeSeconds, 0) / avgResponse.length
                : 0;

            document.getElementById('avg-rating').textContent = avgRating.toFixed(1) + '/5';
            document.getElementById('helpful-rate').textContent = helpfulRate.toFixed(0) + '%';
            document.getElementById('avg-response-time').textContent = responseTime.toFixed(1) + 's';

            document.getElementById('rating-bar').style.width = (avgRating / 5 * 100) + '%';
            document.getElementById('helpful-bar').style.width = helpfulRate + '%';
            document.getElementById('response-time-bar').style.width = Math.min(100, (5 / responseTime) * 100) + '%';

            // Intent breakdown
            const intentTotals = {};
            data.forEach(d => {
                if (d.intentDistribution) {
                    Object.entries(d.intentDistribution).forEach(([intent, count]) => {
                        intentTotals[intent] = (intentTotals[intent] || 0) + count;
                    });
                }
            });
            renderIntentChart(intentTotals);
        }

        function renderConversationsChart(data) {
            const ctx = document.getElementById('conversationsChart').getContext('2d');

            if (conversationsChart) conversationsChart.destroy();

            conversationsChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map(d => new Date(d.snapshotDate).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })),
                    datasets: [
                        {
                            label: 'Total',
                            data: data.map(d => d.totalConversations),
                            borderColor: '#7c3aed',
                            backgroundColor: 'rgba(124, 58, 237, 0.1)',
                            fill: true,
                            tension: 0.4
                        },
                        {
                            label: 'Resolved',
                            data: data.map(d => d.resolvedConversations),
                            borderColor: '#22c55e',
                            backgroundColor: 'transparent',
                            tension: 0.4
                        },
                        {
                            label: 'Escalated',
                            data: data.map(d => d.escalatedConversations),
                            borderColor: '#ef4444',
                            backgroundColor: 'transparent',
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'bottom' } },
                    scales: { y: { beginAtZero: true } }
                }
            });
        }

        function renderResolutionChart(data) {
            const ctx = document.getElementById('resolutionChart').getContext('2d');

            if (resolutionChart) resolutionChart.destroy();

            const resolutionRates = data.map(d => {
                const total = d.resolvedConversations + d.escalatedConversations;
                return total > 0 ? (d.resolvedConversations / total * 100) : 0;
            });

            resolutionChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map(d => new Date(d.snapshotDate).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })),
                    datasets: [{
                        label: 'Resolution Rate %',
                        data: resolutionRates,
                        borderColor: '#0ea5e9',
                        backgroundColor: 'rgba(14, 165, 233, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            ticks: { callback: value => value + '%' }
                        }
                    }
                }
            });
        }

        function renderIntentChart(intents) {
            const ctx = document.getElementById('intentChart').getContext('2d');

            if (intentChart) intentChart.destroy();

            const entries = Object.entries(intents).sort((a, b) => b[1] - a[1]).slice(0, 5);
            const colors = ['#7c3aed', '#ec4899', '#0ea5e9', '#22c55e', '#f59e0b'];

            intentChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: entries.map(([intent]) => formatIntent(intent)),
                    datasets: [{
                        data: entries.map(([, count]) => count),
                        backgroundColor: colors.slice(0, entries.length)
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom', labels: { boxWidth: 12 } }
                    }
                }
            });
        }

        function renderTable(data) {
            const tbody = document.getElementById('analytics-table');

            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted py-4">No data available</td></tr>';
                return;
            }

            tbody.innerHTML = data.slice().reverse().map(d => `
                <tr>
                    <td class="ps-4">
                        <span class="text-sm">${new Date(d.snapshotDate).toLocaleDateString()}</span>
                    </td>
                    <td><span class="text-sm font-weight-bold">${d.totalConversations}</span></td>
                    <td><span class="text-sm text-success">${d.resolvedConversations}</span></td>
                    <td><span class="text-sm text-warning">${d.escalatedConversations}</span></td>
                    <td><span class="text-sm">${d.avgRating > 0 ? d.avgRating.toFixed(1) : '-'}</span></td>
                    <td><span class="text-sm">${d.helpfulPercentage > 0 ? d.helpfulPercentage.toFixed(0) + '%' : '-'}</span></td>
                    <td><span class="text-sm">$${d.totalAiCost.toFixed(2)}</span></td>
                </tr>
            `).join('');
        }

        function formatIntent(intent) {
            return intent
                .replace(/_/g, ' ')
                .replace(/([A-Z])/g, ' $1')
                .trim()
                .split(' ')
                .map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase())
                .join(' ');
        }

        document.getElementById('date-range').addEventListener('change', loadAnalytics);

        document.addEventListener('DOMContentLoaded', loadAnalytics);
    </script>
}
