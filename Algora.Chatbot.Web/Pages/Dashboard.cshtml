@page
@model Algora.Chatbot.Web.Pages.DashboardModel
@{
    ViewData["Title"] = "Dashboard";
}

<div class="container-fluid py-4">
    <div class="row mb-4">
        <div class="col-12">
            <h4 class="mb-0">Chatbot Dashboard</h4>
            <p class="text-muted mb-0">Monitor your AI chatbot performance</p>
        </div>
    </div>

    <!-- Stats Cards -->
    <div class="row mb-4">
        <div class="col-xl-3 col-sm-6 mb-4">
            <div class="card">
                <div class="card-body p-3">
                    <div class="row">
                        <div class="col-8">
                            <div class="numbers">
                                <p class="text-sm mb-0 text-uppercase font-weight-bold text-muted">Today's Chats</p>
                                <h5 class="font-weight-bolder mb-0" id="today-count">-</h5>
                            </div>
                        </div>
                        <div class="col-4 text-end">
                            <div class="icon icon-shape bg-gradient-primary shadow-primary text-center rounded-circle">
                                <i class="fas fa-comments text-lg opacity-10" style="color: #7c3aed;"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-sm-6 mb-4">
            <div class="card">
                <div class="card-body p-3">
                    <div class="row">
                        <div class="col-8">
                            <div class="numbers">
                                <p class="text-sm mb-0 text-uppercase font-weight-bold text-muted">Active Now</p>
                                <h5 class="font-weight-bolder mb-0" id="active-count">-</h5>
                            </div>
                        </div>
                        <div class="col-4 text-end">
                            <div class="icon icon-shape bg-gradient-success shadow-success text-center rounded-circle">
                                <i class="fas fa-user-clock text-lg opacity-10" style="color: #22c55e;"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-sm-6 mb-4">
            <div class="card">
                <div class="card-body p-3">
                    <div class="row">
                        <div class="col-8">
                            <div class="numbers">
                                <p class="text-sm mb-0 text-uppercase font-weight-bold text-muted">Resolution Rate</p>
                                <h5 class="font-weight-bolder mb-0" id="resolution-rate">-</h5>
                            </div>
                        </div>
                        <div class="col-4 text-end">
                            <div class="icon icon-shape bg-gradient-info shadow-info text-center rounded-circle">
                                <i class="fas fa-check-circle text-lg opacity-10" style="color: #0ea5e9;"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-sm-6 mb-4">
            <div class="card">
                <div class="card-body p-3">
                    <div class="row">
                        <div class="col-8">
                            <div class="numbers">
                                <p class="text-sm mb-0 text-uppercase font-weight-bold text-muted">Avg Rating</p>
                                <h5 class="font-weight-bolder mb-0" id="avg-rating">-</h5>
                            </div>
                        </div>
                        <div class="col-4 text-end">
                            <div class="icon icon-shape bg-gradient-warning shadow-warning text-center rounded-circle">
                                <i class="fas fa-star text-lg opacity-10" style="color: #f59e0b;"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Conversation Trend Chart -->
        <div class="col-lg-8 mb-4">
            <div class="card h-100">
                <div class="card-header pb-0">
                    <h6>Conversation Trend</h6>
                    <p class="text-sm text-muted">Last 7 days</p>
                </div>
                <div class="card-body">
                    <canvas id="trendChart" height="200"></canvas>
                </div>
            </div>
        </div>

        <!-- Intent Distribution -->
        <div class="col-lg-4 mb-4">
            <div class="card h-100">
                <div class="card-header pb-0">
                    <h6>Top Intents</h6>
                    <p class="text-sm text-muted">What customers ask about</p>
                </div>
                <div class="card-body">
                    <div id="intent-list">
                        <p class="text-muted text-center">Loading...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Escalated Conversations -->
        <div class="col-lg-6 mb-4">
            <div class="card">
                <div class="card-header pb-0 d-flex justify-content-between align-items-center">
                    <div>
                        <h6>Escalated Conversations</h6>
                        <p class="text-sm text-muted mb-0">Needs human attention</p>
                    </div>
                    <span class="badge bg-danger" id="escalated-badge">0</span>
                </div>
                <div class="card-body px-0 pt-0 pb-2">
                    <div class="table-responsive">
                        <table class="table align-items-center mb-0">
                            <thead>
                                <tr>
                                    <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Customer</th>
                                    <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 ps-2">Intent</th>
                                    <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 ps-2">Time</th>
                                    <th class="text-secondary opacity-7"></th>
                                </tr>
                            </thead>
                            <tbody id="escalated-table">
                                <tr>
                                    <td colspan="4" class="text-center text-muted py-4">No escalated conversations</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- AI Cost Tracker -->
        <div class="col-lg-6 mb-4">
            <div class="card">
                <div class="card-header pb-0">
                    <h6>AI Usage This Month</h6>
                    <p class="text-sm text-muted">Estimated costs</p>
                </div>
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <span>Total AI Cost</span>
                        <span class="font-weight-bold" id="ai-cost">$0.00</span>
                    </div>
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <span>Total Conversations</span>
                        <span class="font-weight-bold" id="month-conversations">0</span>
                    </div>
                    <div class="d-flex justify-content-between align-items-center">
                        <span>Cost per Conversation</span>
                        <span class="font-weight-bold" id="cost-per-conv">$0.00</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        const shop = new URLSearchParams(window.location.search).get('shop') || '@Model.ShopDomain';

        async function loadDashboard() {
            try {
                const response = await fetch(`/api/admin/v1/dashboard?shop=${encodeURIComponent(shop)}`);
                const result = await response.json();

                if (result.success) {
                    const data = result.data;

                    // Update stats cards
                    document.getElementById('today-count').textContent = data.totalConversationsToday;
                    document.getElementById('active-count').textContent = data.activeConversations;
                    document.getElementById('resolution-rate').textContent = data.resolutionRate.toFixed(1) + '%';
                    document.getElementById('avg-rating').textContent = data.avgRating.toFixed(1) + '/5';
                    document.getElementById('escalated-badge').textContent = data.escalatedConversations;
                    document.getElementById('ai-cost').textContent = '$' + data.totalAiCostThisMonth.toFixed(2);
                    document.getElementById('month-conversations').textContent = data.totalConversationsThisMonth;

                    const costPerConv = data.totalConversationsThisMonth > 0
                        ? data.totalAiCostThisMonth / data.totalConversationsThisMonth
                        : 0;
                    document.getElementById('cost-per-conv').textContent = '$' + costPerConv.toFixed(4);

                    // Render trend chart
                    if (data.recentTrend && data.recentTrend.length > 0) {
                        renderTrendChart(data.recentTrend);
                    }

                    // Render intent list
                    if (data.intentDistribution) {
                        renderIntentList(data.intentDistribution);
                    }
                }
            } catch (error) {
                console.error('Failed to load dashboard:', error);
            }
        }

        function renderTrendChart(trend) {
            const ctx = document.getElementById('trendChart').getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: trend.map(t => new Date(t.date).toLocaleDateString('en-US', { weekday: 'short' })),
                    datasets: [
                        {
                            label: 'Total',
                            data: trend.map(t => t.count),
                            borderColor: '#7c3aed',
                            backgroundColor: 'rgba(124, 58, 237, 0.1)',
                            fill: true,
                            tension: 0.4
                        },
                        {
                            label: 'Resolved',
                            data: trend.map(t => t.resolved),
                            borderColor: '#22c55e',
                            backgroundColor: 'transparent',
                            tension: 0.4
                        },
                        {
                            label: 'Escalated',
                            data: trend.map(t => t.escalated),
                            borderColor: '#ef4444',
                            backgroundColor: 'transparent',
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        function renderIntentList(intents) {
            const container = document.getElementById('intent-list');
            const entries = Object.entries(intents).sort((a, b) => b[1] - a[1]).slice(0, 5);

            if (entries.length === 0) {
                container.innerHTML = '<p class="text-muted text-center">No data yet</p>';
                return;
            }

            const total = entries.reduce((sum, [, count]) => sum + count, 0);

            container.innerHTML = entries.map(([intent, count]) => {
                const percentage = ((count / total) * 100).toFixed(0);
                return `
                    <div class="mb-3">
                        <div class="d-flex justify-content-between mb-1">
                            <span class="text-sm">${formatIntent(intent)}</span>
                            <span class="text-sm font-weight-bold">${count}</span>
                        </div>
                        <div class="progress" style="height: 6px;">
                            <div class="progress-bar bg-gradient-primary" role="progressbar"
                                 style="width: ${percentage}%; background: linear-gradient(90deg, #7c3aed, #ec4899);"
                                 aria-valuenow="${percentage}" aria-valuemin="0" aria-valuemax="100"></div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function formatIntent(intent) {
            return intent
                .replace(/_/g, ' ')
                .replace(/([A-Z])/g, ' $1')
                .trim()
                .split(' ')
                .map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase())
                .join(' ');
        }

        // Load on page ready
        document.addEventListener('DOMContentLoaded', loadDashboard);
    </script>
}
