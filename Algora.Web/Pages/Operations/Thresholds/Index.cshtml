@page "/operations/thresholds"
@model Algora.Web.Pages.Operations.Thresholds.IndexModel
@{
    ViewData["Title"] = "Inventory Thresholds";
}

@section css {
    <link rel="stylesheet" href="~/css/datatable.css" asp-append-version="true" />
}

<div class="p-4">
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md">
        <!-- Card Header -->
        <div class="p-6 border-b border-gray-200 dark:border-gray-700">
            <div class="flex flex-wrap items-center justify-between gap-4">
                <div>
                    <h6 class="text-lg font-semibold text-gray-900 dark:text-white">Inventory Thresholds</h6>
                    <p class="text-sm text-gray-500 dark:text-gray-400">
                        Configure per-product stock alerts and auto-reorder settings
                    </p>
                </div>
                <a href="/operations" class="text-gray-900 bg-white border border-gray-300 focus:outline-none hover:bg-gray-100 focus:ring-4 focus:ring-gray-200 font-medium rounded-lg text-sm px-5 py-2.5 dark:bg-gray-800 dark:text-white dark:border-gray-600 dark:hover:bg-gray-700 dark:focus:ring-gray-700">
                    <i class="fas fa-arrow-left me-2"></i> Back
                </a>
            </div>
        </div>

        <!-- Messages -->
        @if (!string.IsNullOrEmpty(Model.SuccessMessage))
        {
            <div class="mx-6 mt-4 flex items-center p-4 text-sm text-green-800 rounded-lg bg-green-50 dark:bg-gray-800 dark:text-green-400" role="alert">
                <i class="fas fa-check-circle me-2"></i>@Model.SuccessMessage
            </div>
        }
        @if (!string.IsNullOrEmpty(Model.ErrorMessage))
        {
            <div class="mx-6 mt-4 flex items-center p-4 text-sm text-red-800 rounded-lg bg-red-50 dark:bg-gray-800 dark:text-red-400" role="alert">
                <i class="fas fa-exclamation-triangle me-2"></i>@Model.ErrorMessage
            </div>
        }

        <!-- Card Body -->
        <div class="p-6">
            @if (Model.Products.Count == 0)
            {
                <div class="text-center py-12">
                    <i class="fas fa-sliders-h fa-4x text-gray-300 dark:text-gray-600 mb-4"></i>
                    <p class="text-gray-500 dark:text-gray-400">No products found. Sync products from Shopify first.</p>
                </div>
            }
            else
            {
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left text-gray-500 dark:text-gray-400" id="thresholds-list">
                        <thead class="text-xs text-gray-700 uppercase bg-gray-50 dark:bg-gray-700 dark:text-gray-400">
                            <tr>
                                <th scope="col" class="px-6 py-3">Product</th>
                                <th scope="col" class="px-6 py-3 text-center">Stock</th>
                                <th scope="col" class="px-6 py-3 text-center">Low/Critical</th>
                                <th scope="col" class="px-6 py-3 text-center">Reorder Point</th>
                                <th scope="col" class="px-6 py-3 text-center">Auto-Reorder</th>
                                <th scope="col" class="px-6 py-3 text-center">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var product in Model.Products)
                            {
                                var hasThreshold = product.Threshold != null;
                                <tr class="bg-white border-b dark:bg-gray-800 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700">
                                    <td class="px-6 py-4">
                                        <div class="font-medium text-gray-900 dark:text-white">@product.Title</div>
                                        @if (!string.IsNullOrEmpty(product.VariantTitle))
                                        {
                                            <p class="text-xs text-gray-500 dark:text-gray-400">@product.VariantTitle</p>
                                        }
                                        @if (!string.IsNullOrEmpty(product.Sku))
                                        {
                                            <p class="text-xs text-gray-500 dark:text-gray-400">SKU: @product.Sku</p>
                                        }
                                    </td>
                                    <td class="px-6 py-4 text-center">
                                        <span class="font-semibold @(product.CurrentStock <= (product.Threshold?.CriticalStockThreshold ?? 5) ? "text-red-600" : product.CurrentStock <= (product.Threshold?.LowStockThreshold ?? 10) ? "text-orange-600" : "text-green-600")">
                                            @product.CurrentStock
                                        </span>
                                    </td>
                                    <td class="px-6 py-4 text-center text-gray-500 dark:text-gray-400">
                                        @if (hasThreshold)
                                        {
                                            <span>@product.Threshold?.LowStockThreshold / @product.Threshold?.CriticalStockThreshold</span>
                                        }
                                        else
                                        {
                                            <span>-</span>
                                        }
                                    </td>
                                    <td class="px-6 py-4 text-center text-gray-500 dark:text-gray-400">
                                        @if (hasThreshold && product.Threshold?.ReorderPoint.HasValue == true)
                                        {
                                            <span>@product.Threshold.ReorderPoint (qty: @(product.Threshold.ReorderQuantity ?? 0))</span>
                                        }
                                        else
                                        {
                                            <span>-</span>
                                        }
                                    </td>
                                    <td class="px-6 py-4 text-center">
                                        @if (product.Threshold?.AutoReorderEnabled == true)
                                        {
                                            <span class="bg-green-100 text-green-800 text-xs font-medium px-2.5 py-0.5 rounded dark:bg-green-900 dark:text-green-300">Enabled</span>
                                        }
                                        else
                                        {
                                            <span class="bg-gray-100 text-gray-800 text-xs font-medium px-2.5 py-0.5 rounded dark:bg-gray-700 dark:text-gray-300">Disabled</span>
                                        }
                                    </td>
                                    <td class="px-6 py-4 text-center">
                                        <button type="button" onclick="openEditModal(@product.ProductId, @(product.ProductVariantId?.ToString() ?? "null"), '@System.Text.Json.JsonSerializer.Serialize(product.Threshold)')" class="text-purple-600 hover:text-purple-800 dark:text-purple-400 dark:hover:text-purple-300 font-medium text-sm" title="Edit">
                                            <i class="fas fa-edit me-1"></i> Configure
                                        </button>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
        </div>
    </div>
</div>

<!-- Edit Modal -->
<div id="editModal" class="hidden fixed inset-0 bg-gray-900/50 overflow-y-auto h-full w-full z-50">
    <div class="relative top-10 mx-auto p-5 border w-[500px] max-w-full shadow-lg rounded-lg bg-white dark:bg-gray-800 dark:border-gray-700">
        <h5 class="mb-4 font-bold text-gray-900 dark:text-white">Configure Threshold</h5>
        <form method="post" asp-page-handler="Save">
            <input type="hidden" asp-for="Input.ProductId" id="modalProductId" />
            <input type="hidden" asp-for="Input.ProductVariantId" id="modalVariantId" />

            <div class="grid grid-cols-2 gap-4 mb-4">
                <div>
                    <label class="block mb-2 text-sm font-bold text-gray-700 dark:text-white">Low Stock Threshold</label>
                    <input type="number" asp-for="Input.LowStockThreshold" id="modalLowStock" min="0" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-purple-500 focus:border-purple-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:text-white" placeholder="e.g., 10" />
                </div>
                <div>
                    <label class="block mb-2 text-sm font-bold text-gray-700 dark:text-white">Critical Stock Threshold</label>
                    <input type="number" asp-for="Input.CriticalStockThreshold" id="modalCriticalStock" min="0" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-purple-500 focus:border-purple-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:text-white" placeholder="e.g., 5" />
                </div>
            </div>

            <div class="grid grid-cols-2 gap-4 mb-4">
                <div>
                    <label class="block mb-2 text-sm font-bold text-gray-700 dark:text-white">Reorder Point</label>
                    <input type="number" asp-for="Input.ReorderPoint" id="modalReorderPoint" min="0" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-purple-500 focus:border-purple-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:text-white" placeholder="e.g., 15" />
                </div>
                <div>
                    <label class="block mb-2 text-sm font-bold text-gray-700 dark:text-white">Reorder Quantity</label>
                    <input type="number" asp-for="Input.ReorderQuantity" id="modalReorderQty" min="0" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-purple-500 focus:border-purple-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:text-white" placeholder="e.g., 50" />
                </div>
            </div>

            <div class="grid grid-cols-2 gap-4 mb-4">
                <div>
                    <label class="block mb-2 text-sm font-bold text-gray-700 dark:text-white">Safety Stock (days)</label>
                    <input type="number" asp-for="Input.SafetyStockDays" id="modalSafetyDays" min="0" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-purple-500 focus:border-purple-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:text-white" placeholder="e.g., 7" />
                </div>
                <div>
                    <label class="block mb-2 text-sm font-bold text-gray-700 dark:text-white">Lead Time (days)</label>
                    <input type="number" asp-for="Input.LeadTimeDays" id="modalLeadTime" min="0" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-purple-500 focus:border-purple-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:text-white" placeholder="e.g., 14" />
                </div>
            </div>

            <div class="mb-4">
                <label class="block mb-2 text-sm font-bold text-gray-700 dark:text-white">Preferred Supplier</label>
                <select asp-for="Input.PreferredSupplierId" id="modalSupplierId" asp-items="Model.Suppliers" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-purple-500 focus:border-purple-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                    <option value="">None</option>
                </select>
            </div>

            <div class="mb-4">
                <label class="flex items-center gap-2">
                    <input type="checkbox" asp-for="Input.AutoReorderEnabled" id="modalAutoReorder" class="w-4 h-4 text-purple-600 bg-gray-100 border-gray-300 rounded focus:ring-purple-500 dark:focus:ring-purple-600 dark:ring-offset-gray-800 focus:ring-2 dark:bg-gray-700 dark:border-gray-600" />
                    <span class="text-sm font-medium text-gray-900 dark:text-white">Enable Auto-Reorder</span>
                </label>
                <p class="text-xs text-gray-500 dark:text-gray-400 ml-6 mt-1">Automatically create purchase orders when stock falls below reorder point</p>
            </div>

            <div class="flex justify-end gap-2">
                <button type="button" onclick="closeEditModal()" class="px-4 py-2 text-sm text-gray-900 bg-white border border-gray-300 rounded-lg hover:bg-gray-100 dark:bg-gray-700 dark:text-white dark:border-gray-600 dark:hover:bg-gray-600">Cancel</button>
                <button type="submit" class="px-4 py-2 text-sm text-white bg-purple-600 rounded-lg hover:bg-purple-700">Save Settings</button>
            </div>
        </form>
    </div>
</div>

@section Scripts {
    <script src="~/js/plugins/datatables.min.js" asp-append-version="true"></script>
    <script>
        if (document.getElementById('thresholds-list')) {
            new simpleDatatables.DataTable("#thresholds-list", {
                searchable: true,
                fixedHeight: false,
                perPage: 25,
                perPageSelect: [10, 25, 50, 100],
                labels: {
                    placeholder: "Search products...",
                    perPage: "per page",
                    noRows: "No products found",
                    info: "Showing {start} to {end} of {rows} products"
                }
            });
        }

        function openEditModal(productId, variantId, thresholdJson) {
            document.getElementById('modalProductId').value = productId;
            document.getElementById('modalVariantId').value = variantId || '';

            // Parse threshold data
            let threshold = null;
            try {
                threshold = thresholdJson && thresholdJson !== 'null' ? JSON.parse(thresholdJson) : null;
            } catch (e) {}

            if (threshold) {
                document.getElementById('modalLowStock').value = threshold.LowStockThreshold || '';
                document.getElementById('modalCriticalStock').value = threshold.CriticalStockThreshold || '';
                document.getElementById('modalReorderPoint').value = threshold.ReorderPoint || '';
                document.getElementById('modalReorderQty').value = threshold.ReorderQuantity || '';
                document.getElementById('modalSafetyDays').value = threshold.SafetyStockDays || '';
                document.getElementById('modalLeadTime').value = threshold.LeadTimeDays || '';
                document.getElementById('modalSupplierId').value = threshold.PreferredSupplierId || '';
                document.getElementById('modalAutoReorder').checked = threshold.AutoReorderEnabled || false;
            } else {
                document.getElementById('modalLowStock').value = '';
                document.getElementById('modalCriticalStock').value = '';
                document.getElementById('modalReorderPoint').value = '';
                document.getElementById('modalReorderQty').value = '';
                document.getElementById('modalSafetyDays').value = '';
                document.getElementById('modalLeadTime').value = '';
                document.getElementById('modalSupplierId').value = '';
                document.getElementById('modalAutoReorder').checked = false;
            }

            document.getElementById('editModal').classList.remove('hidden');
        }

        function closeEditModal() {
            document.getElementById('editModal').classList.add('hidden');
        }
    </script>
}
