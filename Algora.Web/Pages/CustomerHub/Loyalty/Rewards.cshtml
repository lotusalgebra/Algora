@page "/customer-hub/loyalty/rewards"
@model Algora.Web.Pages.CustomerHub.Loyalty.RewardsModel
@{
    ViewData["Title"] = "Loyalty Rewards";
}

<div class="w-full px-6 py-6 mx-auto">
    <!-- Header -->
    <div class="flex items-center justify-between mb-6">
        <div>
            <h5 class="font-bold dark:text-white">Loyalty Rewards</h5>
            <p class="text-sm text-slate-400">Manage rewards that customers can redeem with their points</p>
        </div>
        <div class="flex gap-2">
            <a href="/customer-hub/loyalty" class="inline-block px-4 py-2 text-xs font-bold text-center text-slate-700 uppercase align-middle transition-all border border-slate-300 rounded-lg cursor-pointer ease-soft-in leading-pro tracking-tight-soft bg-white shadow-soft-md bg-150 bg-x-25 hover:scale-102 active:opacity-85 dark:bg-gray-950 dark:text-white dark:border-gray-700">
                <i class="fas fa-arrow-left me-2"></i> Back
            </a>
            <button type="button" onclick="showCreateModal()" class="inline-block px-4 py-2 text-xs font-bold text-center text-white uppercase align-middle transition-all border-0 rounded-lg cursor-pointer ease-soft-in leading-pro tracking-tight-soft bg-gradient-to-tl from-purple-700 to-pink-500 shadow-soft-md bg-150 bg-x-25 hover:scale-102 active:opacity-85">
                <i class="fas fa-plus me-2"></i> Add Reward
            </button>
        </div>
    </div>

    <!-- Success/Error Messages -->
    @if (!string.IsNullOrEmpty(Model.SuccessMessage))
    {
        <div class="p-4 mb-4 text-sm text-green-800 rounded-lg bg-green-50 dark:bg-gray-800 dark:text-green-400" role="alert">
            <i class="fas fa-check-circle me-2"></i> @Model.SuccessMessage
        </div>
    }
    @if (!string.IsNullOrEmpty(Model.ErrorMessage))
    {
        <div class="p-4 mb-4 text-sm text-red-800 rounded-lg bg-red-50 dark:bg-gray-800 dark:text-red-400" role="alert">
            <i class="fas fa-exclamation-circle me-2"></i> @Model.ErrorMessage
        </div>
    }

    @if (Model.Program == null)
    {
        <!-- No Program -->
        <div class="relative flex flex-col min-w-0 break-words bg-white border-0 shadow-soft-xl rounded-2xl bg-clip-border dark:bg-gray-950 dark:shadow-soft-dark-xl">
            <div class="flex-auto p-6 text-center">
                <i class="fas fa-crown fa-4x text-gray-300 mb-4"></i>
                <h5 class="mb-2 dark:text-white">No Loyalty Program</h5>
                <p class="text-sm text-gray-500 dark:text-gray-400 mb-4">Create a loyalty program before adding rewards.</p>
                <a href="/customer-hub/loyalty/settings" class="inline-block px-6 py-3 text-xs font-bold text-center text-white uppercase align-middle transition-all border-0 rounded-lg cursor-pointer ease-soft-in leading-pro tracking-tight-soft bg-gradient-to-tl from-purple-700 to-pink-500 shadow-soft-md bg-150 bg-x-25 hover:scale-102 active:opacity-85">
                    <i class="fas fa-cog me-2"></i> Go to Settings
                </a>
            </div>
        </div>
    }
    else if (Model.Rewards.Count == 0)
    {
        <!-- No Rewards -->
        <div class="relative flex flex-col min-w-0 break-words bg-white border-0 shadow-soft-xl rounded-2xl bg-clip-border dark:bg-gray-950 dark:shadow-soft-dark-xl">
            <div class="flex-auto p-6 text-center">
                <i class="fas fa-gift fa-4x text-gray-300 mb-4"></i>
                <h5 class="mb-2 dark:text-white">No Rewards Yet</h5>
                <p class="text-sm text-gray-500 dark:text-gray-400 mb-4">Create rewards for customers to redeem with their @Model.Program.PointsName.ToLower().</p>
                <button type="button" onclick="showCreateModal()" class="inline-block px-6 py-3 text-xs font-bold text-center text-white uppercase align-middle transition-all border-0 rounded-lg cursor-pointer ease-soft-in leading-pro tracking-tight-soft bg-gradient-to-tl from-purple-700 to-pink-500 shadow-soft-md bg-150 bg-x-25 hover:scale-102 active:opacity-85">
                    <i class="fas fa-plus me-2"></i> Create First Reward
                </button>
            </div>
        </div>
    }
    else
    {
        <!-- Rewards Grid -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            @foreach (var reward in Model.Rewards.OrderBy(r => r.PointsCost))
            {
                <div class="relative flex flex-col min-w-0 break-words bg-white border-0 shadow-soft-xl rounded-2xl bg-clip-border dark:bg-gray-950 dark:shadow-soft-dark-xl @(!reward.IsActive ? "opacity-60" : "")">
                    <!-- Reward Header -->
                    <div class="p-4 rounded-t-2xl bg-gradient-to-tl @Model.GetRewardTypeColor(reward.Type)">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-3">
                                <div class="w-12 h-12 rounded-full bg-white/20 flex items-center justify-center">
                                    <i class="@Model.GetRewardTypeIcon(reward.Type) text-xl text-white"></i>
                                </div>
                                <div>
                                    <h6 class="mb-0 text-white font-bold">@reward.Name</h6>
                                    <p class="text-xs text-white/80 mb-0">@Model.GetRewardTypeLabel(reward.Type)</p>
                                </div>
                            </div>
                            <div class="text-right">
                                <p class="text-2xl font-bold text-white mb-0">@reward.PointsCost</p>
                                <p class="text-xs text-white/80 mb-0">@Model.Program.PointsName</p>
                            </div>
                        </div>
                    </div>

                    <!-- Reward Body -->
                    <div class="flex-auto p-4">
                        @if (!string.IsNullOrEmpty(reward.Description))
                        {
                            <p class="text-sm text-slate-600 dark:text-gray-400 mb-3">@reward.Description</p>
                        }

                        <div class="flex flex-wrap gap-2 mb-3">
                            @if (reward.Type == "discount_percent")
                            {
                                <span class="px-2 py-1 text-xs font-semibold bg-blue-100 text-blue-700 rounded">@reward.Value.ToString("0")% off</span>
                            }
                            else if (reward.Type == "discount_fixed")
                            {
                                <span class="px-2 py-1 text-xs font-semibold bg-green-100 text-green-700 rounded">$@reward.Value.ToString("0.00") off</span>
                            }
                            else if (reward.Type == "free_shipping")
                            {
                                <span class="px-2 py-1 text-xs font-semibold bg-purple-100 text-purple-700 rounded">Free Shipping</span>
                            }
                            else if (reward.Type == "free_product")
                            {
                                <span class="px-2 py-1 text-xs font-semibold bg-orange-100 text-orange-700 rounded">Free Product</span>
                            }

                            @if (reward.MinimumOrderAmount.HasValue)
                            {
                                <span class="px-2 py-1 text-xs font-semibold bg-gray-100 text-gray-700 rounded dark:bg-gray-800 dark:text-gray-300">Min $@reward.MinimumOrderAmount.Value.ToString("0.00")</span>
                            }

                            @if (reward.MaxRedemptions.HasValue)
                            {
                                <span class="px-2 py-1 text-xs font-semibold bg-gray-100 text-gray-700 rounded dark:bg-gray-800 dark:text-gray-300">Max @reward.MaxRedemptions.Value/customer</span>
                            }
                        </div>

                        <div class="flex items-center justify-between text-xs text-slate-400">
                            <div>
                                <i class="fas fa-chart-bar me-1"></i> @reward.RedemptionCount redeemed
                            </div>
                            @if (!reward.IsActive)
                            {
                                <span class="px-2 py-1 bg-red-100 text-red-700 rounded text-xs font-semibold">Inactive</span>
                            }
                            else if (reward.EndsAt.HasValue && reward.EndsAt.Value < DateTime.UtcNow)
                            {
                                <span class="px-2 py-1 bg-gray-100 text-gray-700 rounded text-xs font-semibold">Expired</span>
                            }
                            else if (reward.StartsAt.HasValue && reward.StartsAt.Value > DateTime.UtcNow)
                            {
                                <span class="px-2 py-1 bg-yellow-100 text-yellow-700 rounded text-xs font-semibold">Scheduled</span>
                            }
                            else
                            {
                                <span class="px-2 py-1 bg-green-100 text-green-700 rounded text-xs font-semibold">Active</span>
                            }
                        </div>
                    </div>

                    <!-- Reward Footer -->
                    <div class="px-4 py-3 border-t border-gray-100 dark:border-gray-800 flex justify-between items-center">
                        <form method="post" asp-page-handler="ToggleReward" asp-route-id="@reward.Id" class="inline">
                            <button type="submit" class="text-xs font-semibold @(reward.IsActive ? "text-orange-500 hover:text-orange-700" : "text-green-500 hover:text-green-700")">
                                <i class="fas @(reward.IsActive ? "fa-pause" : "fa-play") me-1"></i> @(reward.IsActive ? "Deactivate" : "Activate")
                            </button>
                        </form>
                        <div class="flex gap-2">
                            <button type="button" onclick='editReward(@Html.Raw(System.Text.Json.JsonSerializer.Serialize(new { reward.Id, reward.Name, reward.Description, reward.Type, reward.PointsCost, reward.Value, reward.MinimumOrderAmount, reward.MaxRedemptions, reward.IsActive, StartsAt = reward.StartsAt?.ToString("yyyy-MM-ddTHH:mm"), EndsAt = reward.EndsAt?.ToString("yyyy-MM-ddTHH:mm"), reward.ImageUrl })))' class="px-3 py-1 text-xs font-semibold text-fuchsia-500 border border-fuchsia-500 rounded hover:bg-fuchsia-50 dark:hover:bg-gray-700">
                                <i class="fas fa-edit"></i> Edit
                            </button>
                            <form method="post" asp-page-handler="DeleteReward" asp-route-id="@reward.Id" class="inline" onsubmit="return confirm('Delete this reward?');">
                                <button type="submit" class="px-3 py-1 text-xs font-semibold text-red-500 border border-red-500 rounded hover:bg-red-50 dark:hover:bg-gray-700">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            }
        </div>
    }
</div>

<!-- Create/Edit Modal -->
<div id="rewardModal" class="fixed inset-0 z-50 hidden overflow-y-auto" aria-modal="true">
    <div class="flex items-center justify-center min-h-screen px-4 pt-4 pb-20 text-center sm:p-0">
        <div class="fixed inset-0 transition-opacity bg-gray-500 bg-opacity-75" onclick="closeModal()"></div>

        <div class="relative inline-block px-4 pt-5 pb-4 overflow-hidden text-left align-bottom transition-all transform bg-white rounded-2xl shadow-xl sm:my-8 sm:align-middle sm:max-w-lg sm:w-full sm:p-6 dark:bg-gray-950">
            <form method="post" asp-page-handler="SaveReward">
                <div class="flex items-center justify-between mb-4">
                    <h5 class="text-lg font-bold dark:text-white" id="modalTitle">Add Reward</h5>
                    <button type="button" onclick="closeModal()" class="text-gray-400 hover:text-gray-500">
                        <i class="fas fa-times"></i>
                    </button>
                </div>

                <input type="hidden" asp-for="RewardForm.Id" id="rewardId" />

                <div class="mb-4">
                    <label class="mb-2 ml-1 font-bold text-xs text-slate-700 dark:text-white/80">Reward Name</label>
                    <input type="text" asp-for="RewardForm.Name" id="rewardName" class="focus:shadow-soft-primary-outline dark:bg-gray-950 dark:placeholder:text-white/80 dark:text-white/80 text-sm leading-5.6 ease-soft block w-full appearance-none rounded-lg border border-solid border-gray-300 bg-white bg-clip-padding px-3 py-2 font-normal text-gray-700 outline-none transition-all placeholder:text-gray-500 focus:border-fuchsia-300 focus:outline-none" placeholder="$5 Off Your Order" required />
                </div>

                <div class="mb-4">
                    <label class="mb-2 ml-1 font-bold text-xs text-slate-700 dark:text-white/80">Description</label>
                    <textarea asp-for="RewardForm.Description" id="rewardDescription" rows="2" class="focus:shadow-soft-primary-outline dark:bg-gray-950 dark:placeholder:text-white/80 dark:text-white/80 text-sm leading-5.6 ease-soft block w-full appearance-none rounded-lg border border-solid border-gray-300 bg-white bg-clip-padding px-3 py-2 font-normal text-gray-700 outline-none transition-all placeholder:text-gray-500 focus:border-fuchsia-300 focus:outline-none" placeholder="Get $5 off your next order"></textarea>
                </div>

                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="mb-2 ml-1 font-bold text-xs text-slate-700 dark:text-white/80">Reward Type</label>
                        <select asp-for="RewardForm.Type" id="rewardType" onchange="updateValueLabel()" class="focus:shadow-soft-primary-outline dark:bg-gray-950 dark:placeholder:text-white/80 dark:text-white/80 text-sm leading-5.6 ease-soft block w-full appearance-none rounded-lg border border-solid border-gray-300 bg-white bg-clip-padding px-3 py-2 font-normal text-gray-700 outline-none transition-all placeholder:text-gray-500 focus:border-fuchsia-300 focus:outline-none">
                            <option value="discount_fixed">Fixed Discount ($)</option>
                            <option value="discount_percent">Percentage Discount (%)</option>
                            <option value="free_shipping">Free Shipping</option>
                        </select>
                    </div>
                    <div>
                        <label class="mb-2 ml-1 font-bold text-xs text-slate-700 dark:text-white/80">Points Cost</label>
                        <input type="number" asp-for="RewardForm.PointsCost" id="rewardPoints" min="1" class="focus:shadow-soft-primary-outline dark:bg-gray-950 dark:placeholder:text-white/80 dark:text-white/80 text-sm leading-5.6 ease-soft block w-full appearance-none rounded-lg border border-solid border-gray-300 bg-white bg-clip-padding px-3 py-2 font-normal text-gray-700 outline-none transition-all placeholder:text-gray-500 focus:border-fuchsia-300 focus:outline-none" required />
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div id="valueContainer">
                        <label class="mb-2 ml-1 font-bold text-xs text-slate-700 dark:text-white/80" id="valueLabel">Value ($)</label>
                        <input type="number" asp-for="RewardForm.Value" id="rewardValue" step="0.01" min="0" class="focus:shadow-soft-primary-outline dark:bg-gray-950 dark:placeholder:text-white/80 dark:text-white/80 text-sm leading-5.6 ease-soft block w-full appearance-none rounded-lg border border-solid border-gray-300 bg-white bg-clip-padding px-3 py-2 font-normal text-gray-700 outline-none transition-all placeholder:text-gray-500 focus:border-fuchsia-300 focus:outline-none" />
                    </div>
                    <div>
                        <label class="mb-2 ml-1 font-bold text-xs text-slate-700 dark:text-white/80">Min Order Amount</label>
                        <input type="number" asp-for="RewardForm.MinimumOrderAmount" id="rewardMinOrder" step="0.01" min="0" class="focus:shadow-soft-primary-outline dark:bg-gray-950 dark:placeholder:text-white/80 dark:text-white/80 text-sm leading-5.6 ease-soft block w-full appearance-none rounded-lg border border-solid border-gray-300 bg-white bg-clip-padding px-3 py-2 font-normal text-gray-700 outline-none transition-all placeholder:text-gray-500 focus:border-fuchsia-300 focus:outline-none" placeholder="Optional" />
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="mb-2 ml-1 font-bold text-xs text-slate-700 dark:text-white/80">Max Per Customer</label>
                        <input type="number" asp-for="RewardForm.MaxRedemptions" id="rewardMaxRedemptions" min="1" class="focus:shadow-soft-primary-outline dark:bg-gray-950 dark:placeholder:text-white/80 dark:text-white/80 text-sm leading-5.6 ease-soft block w-full appearance-none rounded-lg border border-solid border-gray-300 bg-white bg-clip-padding px-3 py-2 font-normal text-gray-700 outline-none transition-all placeholder:text-gray-500 focus:border-fuchsia-300 focus:outline-none" placeholder="Unlimited" />
                    </div>
                    <div class="flex items-end">
                        <label class="inline-flex items-center cursor-pointer">
                            <input type="checkbox" asp-for="RewardForm.IsActive" id="rewardActive" class="sr-only peer" checked />
                            <div class="relative w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-fuchsia-300 dark:peer-focus:ring-fuchsia-800 rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-fuchsia-500"></div>
                            <span class="ml-3 text-sm font-medium text-gray-700 dark:text-gray-300">Active</span>
                        </label>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4 mb-6">
                    <div>
                        <label class="mb-2 ml-1 font-bold text-xs text-slate-700 dark:text-white/80">Start Date (Optional)</label>
                        <input type="datetime-local" asp-for="RewardForm.StartsAt" id="rewardStartsAt" class="focus:shadow-soft-primary-outline dark:bg-gray-950 dark:placeholder:text-white/80 dark:text-white/80 text-sm leading-5.6 ease-soft block w-full appearance-none rounded-lg border border-solid border-gray-300 bg-white bg-clip-padding px-3 py-2 font-normal text-gray-700 outline-none transition-all placeholder:text-gray-500 focus:border-fuchsia-300 focus:outline-none" />
                    </div>
                    <div>
                        <label class="mb-2 ml-1 font-bold text-xs text-slate-700 dark:text-white/80">End Date (Optional)</label>
                        <input type="datetime-local" asp-for="RewardForm.EndsAt" id="rewardEndsAt" class="focus:shadow-soft-primary-outline dark:bg-gray-950 dark:placeholder:text-white/80 dark:text-white/80 text-sm leading-5.6 ease-soft block w-full appearance-none rounded-lg border border-solid border-gray-300 bg-white bg-clip-padding px-3 py-2 font-normal text-gray-700 outline-none transition-all placeholder:text-gray-500 focus:border-fuchsia-300 focus:outline-none" />
                    </div>
                </div>

                <div class="flex gap-2">
                    <button type="button" onclick="closeModal()" class="flex-1 px-4 py-3 text-xs font-bold text-center text-slate-700 uppercase align-middle transition-all border border-slate-300 rounded-lg cursor-pointer ease-soft-in leading-pro tracking-tight-soft bg-white hover:scale-102 active:opacity-85 dark:bg-gray-900 dark:text-white dark:border-gray-700">
                        Cancel
                    </button>
                    <button type="submit" class="flex-1 px-4 py-3 text-xs font-bold text-center text-white uppercase align-middle transition-all border-0 rounded-lg cursor-pointer ease-soft-in leading-pro tracking-tight-soft bg-gradient-to-tl from-purple-700 to-pink-500 shadow-soft-md bg-150 bg-x-25 hover:scale-102 active:opacity-85">
                        <i class="fas fa-save me-2"></i> Save Reward
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
<script>
    function showCreateModal() {
        document.getElementById('rewardId').value = '';
        document.getElementById('rewardName').value = '';
        document.getElementById('rewardDescription').value = '';
        document.getElementById('rewardType').value = 'discount_fixed';
        document.getElementById('rewardPoints').value = '100';
        document.getElementById('rewardValue').value = '5.00';
        document.getElementById('rewardMinOrder').value = '';
        document.getElementById('rewardMaxRedemptions').value = '';
        document.getElementById('rewardActive').checked = true;
        document.getElementById('rewardStartsAt').value = '';
        document.getElementById('rewardEndsAt').value = '';
        document.getElementById('modalTitle').textContent = 'Add Reward';
        updateValueLabel();
        document.getElementById('rewardModal').classList.remove('hidden');
    }

    function editReward(reward) {
        document.getElementById('rewardId').value = reward.Id;
        document.getElementById('rewardName').value = reward.Name;
        document.getElementById('rewardDescription').value = reward.Description || '';
        document.getElementById('rewardType').value = reward.Type;
        document.getElementById('rewardPoints').value = reward.PointsCost;
        document.getElementById('rewardValue').value = reward.Value;
        document.getElementById('rewardMinOrder').value = reward.MinimumOrderAmount || '';
        document.getElementById('rewardMaxRedemptions').value = reward.MaxRedemptions || '';
        document.getElementById('rewardActive').checked = reward.IsActive;
        document.getElementById('rewardStartsAt').value = reward.StartsAt || '';
        document.getElementById('rewardEndsAt').value = reward.EndsAt || '';
        document.getElementById('modalTitle').textContent = 'Edit Reward';
        updateValueLabel();
        document.getElementById('rewardModal').classList.remove('hidden');
    }

    function closeModal() {
        document.getElementById('rewardModal').classList.add('hidden');
    }

    function updateValueLabel() {
        var type = document.getElementById('rewardType').value;
        var label = document.getElementById('valueLabel');
        var container = document.getElementById('valueContainer');

        if (type === 'discount_percent') {
            label.textContent = 'Discount (%)';
            container.style.display = 'block';
        } else if (type === 'discount_fixed') {
            label.textContent = 'Discount Amount ($)';
            container.style.display = 'block';
        } else if (type === 'free_shipping') {
            label.textContent = 'Value ($)';
            container.style.display = 'none';
        } else {
            label.textContent = 'Value';
            container.style.display = 'block';
        }
    }

    // Close modal on escape key
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            closeModal();
        }
    });
</script>
}
