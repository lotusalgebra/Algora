@page "/communication/campaigns/edit/{id:int}"
@model Algora.Web.Pages.Communication.CampaignEditModel
@{
    ViewData["Title"] = "Edit Campaign";
}

<div class="p-4">
    <!-- Header -->
    <div class="flex flex-wrap items-center justify-between gap-4 mb-6">
        <div class="flex items-center gap-3">
            <a href="/communication/email-campaigns" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-white">
                <i class="fas fa-arrow-left"></i>
            </a>
            <div>
                <h1 class="text-xl font-bold text-gray-900 dark:text-white">Edit Campaign</h1>
                <p class="text-sm text-gray-500 dark:text-gray-400">
                    @if (Model.Campaign != null)
                    {
                        <span class="px-2 py-0.5 text-xs font-medium rounded @(Model.Campaign.Status == "draft" ? "bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-300" : Model.Campaign.Status == "sent" ? "bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-300" : "bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-300")">
                            @Model.Campaign.Status.ToUpper()
                        </span>
                    }
                </p>
            </div>
        </div>
        <div class="flex gap-2">
            @if (Model.Campaign?.Status == "draft")
            {
                <button type="button" onclick="document.getElementById('saveForm').submit()" class="inline-flex items-center px-4 py-2.5 text-sm font-medium text-gray-900 bg-white border border-gray-300 rounded-lg hover:bg-gray-100 dark:bg-gray-800 dark:text-white dark:border-gray-600 dark:hover:bg-gray-700">
                    <i class="fas fa-save me-2"></i> Save Draft
                </button>
                <button type="button" onclick="openScheduleModal()" class="inline-flex items-center px-4 py-2.5 text-sm font-medium text-white bg-gradient-to-br from-blue-500 to-cyan-400 rounded-lg hover:bg-gradient-to-bl">
                    <i class="fas fa-clock me-2"></i> Schedule
                </button>
                <button type="button" onclick="confirmSend()" class="inline-flex items-center px-4 py-2.5 text-sm font-medium text-white bg-gradient-to-br from-purple-600 to-pink-500 rounded-lg hover:bg-gradient-to-bl">
                    <i class="fas fa-paper-plane me-2"></i> Send Now
                </button>
            }
        </div>
    </div>

    @if (!string.IsNullOrEmpty(Model.ErrorMessage))
    {
        <div class="flex items-center p-4 mb-6 text-sm text-red-800 rounded-lg bg-red-50 dark:bg-gray-800 dark:text-red-400" role="alert">
            <i class="fas fa-exclamation-circle me-2"></i>@Model.ErrorMessage
        </div>
    }

    @if (!string.IsNullOrEmpty(Model.SuccessMessage))
    {
        <div class="flex items-center p-4 mb-6 text-sm text-green-800 rounded-lg bg-green-50 dark:bg-gray-800 dark:text-green-400" role="alert">
            <i class="fas fa-check-circle me-2"></i>@Model.SuccessMessage
        </div>
    }

    @if (Model.Campaign == null)
    {
        <div class="text-center py-12">
            <i class="fas fa-exclamation-triangle text-6xl text-gray-300 dark:text-gray-600 mb-4"></i>
            <p class="text-gray-500 dark:text-gray-400">Campaign not found.</p>
            <a href="/communication/email-campaigns" class="inline-flex items-center mt-4 px-4 py-2.5 text-sm font-medium text-white bg-gradient-to-br from-purple-600 to-pink-500 rounded-lg hover:bg-gradient-to-bl">
                <i class="fas fa-arrow-left me-2"></i> Back to Campaigns
            </a>
        </div>
    }
    else
    {
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Main Editor -->
            <div class="lg:col-span-2">
                <form id="saveForm" method="post" asp-page-handler="Save">
                    <input type="hidden" asp-for="Input.Id" />

                    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6 mb-6">
                        <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Campaign Details</h3>

                        <div class="mb-4">
                            <label class="block mb-2 text-sm font-bold text-gray-700 dark:text-white">Campaign Name *</label>
                            <input type="text" asp-for="Input.Name" required class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-purple-500 focus:border-purple-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:text-white" placeholder="My Campaign" />
                        </div>

                        <div class="grid grid-cols-2 gap-4 mb-4">
                            <div>
                                <label class="block mb-2 text-sm font-bold text-gray-700 dark:text-white">From Name</label>
                                <input type="text" asp-for="Input.FromName" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-purple-500 focus:border-purple-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:text-white" placeholder="Your Store" />
                            </div>
                            <div>
                                <label class="block mb-2 text-sm font-bold text-gray-700 dark:text-white">From Email</label>
                                <input type="email" asp-for="Input.FromEmail" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-purple-500 focus:border-purple-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:text-white" placeholder="hello@yourstore.com" />
                            </div>
                        </div>
                    </div>

                    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6 mb-6">
                        <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Email Content</h3>

                        <div class="mb-4">
                            <label class="block mb-2 text-sm font-bold text-gray-700 dark:text-white">Subject Line *</label>
                            <input type="text" asp-for="Input.Subject" required class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-purple-500 focus:border-purple-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:text-white" placeholder="Check out our latest offers!" />
                            <p class="mt-1 text-xs text-gray-500">Use {{customer_name}} for personalization</p>
                        </div>

                        <div class="mb-4">
                            <label class="block mb-2 text-sm font-bold text-gray-700 dark:text-white">Preview Text</label>
                            <input type="text" asp-for="Input.PreviewText" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-purple-500 focus:border-purple-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:text-white" placeholder="This appears in email previews..." />
                        </div>

                        <div class="mb-4">
                            <div class="flex items-center justify-between mb-2">
                                <label class="text-sm font-bold text-gray-700 dark:text-white">Email Body *</label>
                                <div class="flex gap-2">
                                    <button type="button" onclick="toggleEditor('visual')" id="visualBtn" class="px-3 py-1 text-xs font-medium text-white bg-purple-600 rounded">Visual</button>
                                    <button type="button" onclick="toggleEditor('html')" id="htmlBtn" class="px-3 py-1 text-xs font-medium text-gray-600 bg-gray-200 dark:bg-gray-600 dark:text-gray-300 rounded">HTML</button>
                                </div>
                            </div>

                            <!-- Visual Editor (Quill) -->
                            <div id="visualEditor" class="mb-2">
                                <div id="quillEditor" class="bg-white dark:bg-gray-700 rounded-lg border border-gray-300 dark:border-gray-600" style="min-height: 400px;"></div>
                            </div>

                            <!-- HTML Editor -->
                            <div id="htmlEditor" class="hidden">
                                <textarea id="htmlContent" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-purple-500 focus:border-purple-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:text-white font-mono" style="min-height: 400px;"></textarea>
                            </div>

                            <!-- Hidden input for form submission -->
                            <input type="hidden" asp-for="Input.Body" id="bodyInput" />

                            <p class="mt-2 text-xs text-gray-500">
                                <strong>Variables:</strong> {{customer_name}}, {{customer_email}}, {{shop_name}}, {{shop_url}}, {{order_number}}
                            </p>
                        </div>
                    </div>
                </form>
            </div>

            <!-- Sidebar -->
            <div class="lg:col-span-1">
                <!-- Load Template -->
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6 mb-6">
                    <h4 class="font-semibold text-gray-900 dark:text-white mb-3">
                        <i class="fas fa-file-code me-2 text-purple-500"></i> Load Template
                    </h4>
                    @if (Model.Templates.Any())
                    {
                        <form method="post" asp-page-handler="LoadTemplate">
                            <input type="hidden" asp-for="Input.Id" />
                            <input type="hidden" asp-for="Input.Name" />
                            <select name="templateId" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-purple-500 focus:border-purple-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:text-white mb-3">
                                <option value="">Select a template...</option>
                                @foreach (var template in Model.Templates)
                                {
                                    <option value="@template.Id">@template.Name (@template.TemplateType)</option>
                                }
                            </select>
                            <button type="submit" class="w-full px-4 py-2 text-sm font-medium text-purple-600 bg-purple-50 rounded-lg hover:bg-purple-100 dark:bg-purple-900/30 dark:text-purple-400">
                                <i class="fas fa-download me-2"></i> Load Template
                            </button>
                        </form>
                    }
                    else
                    {
                        <p class="text-sm text-gray-500 dark:text-gray-400">No templates available.</p>
                    }
                </div>

                <!-- Campaign Info -->
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6 mb-6">
                    <h4 class="font-semibold text-gray-900 dark:text-white mb-3">
                        <i class="fas fa-info-circle me-2 text-blue-500"></i> Campaign Info
                    </h4>
                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between">
                            <span class="text-gray-500 dark:text-gray-400">Status:</span>
                            <span class="font-medium text-gray-900 dark:text-white capitalize">@Model.Campaign.Status</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-500 dark:text-gray-400">Created:</span>
                            <span class="font-medium text-gray-900 dark:text-white">@Model.Campaign.CreatedAt.ToString("MMM dd, yyyy")</span>
                        </div>
                        @if (Model.Campaign.ScheduledAt.HasValue)
                        {
                            <div class="flex justify-between">
                                <span class="text-gray-500 dark:text-gray-400">Scheduled:</span>
                                <span class="font-medium text-gray-900 dark:text-white">@Model.Campaign.ScheduledAt.Value.ToString("MMM dd, yyyy HH:mm")</span>
                            </div>
                        }
                        @if (Model.Campaign.SentAt.HasValue)
                        {
                            <div class="flex justify-between">
                                <span class="text-gray-500 dark:text-gray-400">Sent:</span>
                                <span class="font-medium text-gray-900 dark:text-white">@Model.Campaign.SentAt.Value.ToString("MMM dd, yyyy HH:mm")</span>
                            </div>
                        }
                    </div>
                </div>

                <!-- Stats (if sent) -->
                @if (Model.Campaign.Status == "sent" || Model.Campaign.TotalSent > 0)
                {
                    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6 mb-6">
                        <h4 class="font-semibold text-gray-900 dark:text-white mb-3">
                            <i class="fas fa-chart-bar me-2 text-green-500"></i> Performance
                        </h4>
                        <div class="space-y-3">
                            <div>
                                <div class="flex justify-between text-sm mb-1">
                                    <span class="text-gray-500 dark:text-gray-400">Sent</span>
                                    <span class="font-medium text-gray-900 dark:text-white">@Model.Campaign.TotalSent</span>
                                </div>
                            </div>
                            <div>
                                <div class="flex justify-between text-sm mb-1">
                                    <span class="text-gray-500 dark:text-gray-400">Delivered</span>
                                    <span class="font-medium text-gray-900 dark:text-white">@Model.Campaign.TotalDelivered</span>
                                </div>
                                <div class="w-full bg-gray-200 rounded-full h-1.5 dark:bg-gray-700">
                                    @{ var deliveryRate = Model.Campaign.TotalSent > 0 ? (double)Model.Campaign.TotalDelivered / Model.Campaign.TotalSent * 100 : 0; }
                                    <div class="bg-blue-600 h-1.5 rounded-full" style="width: @deliveryRate.ToString("0")%"></div>
                                </div>
                            </div>
                            <div>
                                <div class="flex justify-between text-sm mb-1">
                                    <span class="text-gray-500 dark:text-gray-400">Opened</span>
                                    <span class="font-medium text-green-600 dark:text-green-400">@Model.Campaign.TotalOpened (@((Model.Campaign.TotalSent > 0 ? (double)Model.Campaign.TotalOpened / Model.Campaign.TotalSent * 100 : 0).ToString("0.1"))%)</span>
                                </div>
                                <div class="w-full bg-gray-200 rounded-full h-1.5 dark:bg-gray-700">
                                    @{ var openRate = Model.Campaign.TotalSent > 0 ? (double)Model.Campaign.TotalOpened / Model.Campaign.TotalSent * 100 : 0; }
                                    <div class="bg-green-500 h-1.5 rounded-full" style="width: @openRate.ToString("0")%"></div>
                                </div>
                            </div>
                            <div>
                                <div class="flex justify-between text-sm mb-1">
                                    <span class="text-gray-500 dark:text-gray-400">Clicked</span>
                                    <span class="font-medium text-purple-600 dark:text-purple-400">@Model.Campaign.TotalClicked (@((Model.Campaign.TotalOpened > 0 ? (double)Model.Campaign.TotalClicked / Model.Campaign.TotalOpened * 100 : 0).ToString("0.1"))%)</span>
                                </div>
                                <div class="w-full bg-gray-200 rounded-full h-1.5 dark:bg-gray-700">
                                    @{ var clickRate = Model.Campaign.TotalOpened > 0 ? (double)Model.Campaign.TotalClicked / Model.Campaign.TotalOpened * 100 : 0; }
                                    <div class="bg-purple-500 h-1.5 rounded-full" style="width: @clickRate.ToString("0")%"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                }

                <!-- Preview -->
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6">
                    <h4 class="font-semibold text-gray-900 dark:text-white mb-3">
                        <i class="fas fa-eye me-2 text-cyan-500"></i> Preview
                    </h4>
                    <button type="button" onclick="openPreviewModal()" class="w-full px-4 py-2 text-sm font-medium text-cyan-600 bg-cyan-50 rounded-lg hover:bg-cyan-100 dark:bg-cyan-900/30 dark:text-cyan-400">
                        <i class="fas fa-mobile-alt me-2"></i> Preview Email
                    </button>
                </div>
            </div>
        </div>
    }
</div>

<!-- Schedule Modal -->
<div id="scheduleModal" class="fixed inset-0 bg-gray-900/50 backdrop-blur-sm hidden items-center justify-center z-50">
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-md w-full mx-4">
        <div class="p-6">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Schedule Campaign</h3>
                <button type="button" onclick="closeScheduleModal()" class="text-gray-400 hover:text-gray-600 dark:hover:text-white">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <form method="post" asp-page-handler="Schedule">
                <input type="hidden" asp-for="Input.Id" />
                <input type="hidden" asp-for="Input.Name" />
                <input type="hidden" asp-for="Input.Subject" />
                <input type="hidden" asp-for="Input.PreviewText" />
                <input type="hidden" asp-for="Input.Body" id="scheduleBodyInput" />
                <input type="hidden" asp-for="Input.FromName" />
                <input type="hidden" asp-for="Input.FromEmail" />

                <div class="mb-4">
                    <label class="block mb-2 text-sm font-bold text-gray-700 dark:text-white">Schedule Date & Time</label>
                    <input type="datetime-local" name="scheduledAt" required class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-purple-500 focus:border-purple-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:text-white" />
                </div>
                <div class="flex justify-end gap-3">
                    <button type="button" onclick="closeScheduleModal()" class="px-4 py-2.5 text-sm font-medium text-gray-900 bg-white border border-gray-300 rounded-lg hover:bg-gray-100 dark:bg-gray-800 dark:text-white dark:border-gray-600 dark:hover:bg-gray-700">Cancel</button>
                    <button type="submit" class="px-4 py-2.5 text-sm font-medium text-white bg-gradient-to-br from-blue-500 to-cyan-400 rounded-lg hover:bg-gradient-to-bl">Schedule</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Send Confirmation Form -->
<form id="sendForm" method="post" asp-page-handler="Send" class="hidden">
    <input type="hidden" asp-for="Input.Id" />
    <input type="hidden" asp-for="Input.Name" />
    <input type="hidden" asp-for="Input.Subject" />
    <input type="hidden" asp-for="Input.PreviewText" />
    <input type="hidden" asp-for="Input.Body" id="sendBodyInput" />
    <input type="hidden" asp-for="Input.FromName" />
    <input type="hidden" asp-for="Input.FromEmail" />
</form>

<!-- Preview Modal -->
<div id="previewModal" class="fixed inset-0 bg-gray-900/50 backdrop-blur-sm hidden items-center justify-center z-50">
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-hidden">
        <div class="p-4 border-b border-gray-200 dark:border-gray-700 flex items-center justify-between">
            <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Email Preview</h3>
            <button type="button" onclick="closePreviewModal()" class="text-gray-400 hover:text-gray-600 dark:hover:text-white">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="p-4 bg-gray-100 dark:bg-gray-900">
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow max-w-lg mx-auto">
                <div class="p-4 border-b border-gray-200 dark:border-gray-700">
                    <p class="text-sm text-gray-500 dark:text-gray-400">From: <span id="previewFrom" class="font-medium text-gray-900 dark:text-white"></span></p>
                    <p class="text-sm text-gray-500 dark:text-gray-400">Subject: <span id="previewSubject" class="font-medium text-gray-900 dark:text-white"></span></p>
                </div>
                <div id="previewBody" class="p-4 overflow-y-auto" style="max-height: 400px;"></div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <link href="https://cdn.quilljs.com/1.3.7/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.7/quill.min.js"></script>
    <script>
        let quill;
        let currentMode = 'visual';

        document.addEventListener('DOMContentLoaded', function() {
            // Initialize Quill editor
            quill = new Quill('#quillEditor', {
                theme: 'snow',
                modules: {
                    toolbar: [
                        [{ 'header': [1, 2, 3, false] }],
                        ['bold', 'italic', 'underline', 'strike'],
                        [{ 'color': [] }, { 'background': [] }],
                        [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                        [{ 'align': [] }],
                        ['link', 'image'],
                        ['clean']
                    ]
                },
                placeholder: 'Write your email content here...'
            });

            // Load existing content
            const initialBody = document.getElementById('bodyInput').value;
            if (initialBody) {
                quill.root.innerHTML = initialBody;
                document.getElementById('htmlContent').value = initialBody;
            }

            // Sync content on change
            quill.on('text-change', function() {
                syncContent();
            });

            // Sync on form submit
            document.getElementById('saveForm').addEventListener('submit', function() {
                syncContent();
            });
        });

        function syncContent() {
            const html = quill.root.innerHTML;
            document.getElementById('bodyInput').value = html;
            document.getElementById('htmlContent').value = html;
            document.getElementById('sendBodyInput').value = html;
            document.getElementById('scheduleBodyInput').value = html;
        }

        function toggleEditor(mode) {
            currentMode = mode;
            const visualEditor = document.getElementById('visualEditor');
            const htmlEditor = document.getElementById('htmlEditor');
            const visualBtn = document.getElementById('visualBtn');
            const htmlBtn = document.getElementById('htmlBtn');

            if (mode === 'visual') {
                visualEditor.classList.remove('hidden');
                htmlEditor.classList.add('hidden');
                visualBtn.classList.add('text-white', 'bg-purple-600');
                visualBtn.classList.remove('text-gray-600', 'bg-gray-200', 'dark:bg-gray-600', 'dark:text-gray-300');
                htmlBtn.classList.remove('text-white', 'bg-purple-600');
                htmlBtn.classList.add('text-gray-600', 'bg-gray-200', 'dark:bg-gray-600', 'dark:text-gray-300');

                // Sync HTML to Quill
                const htmlContent = document.getElementById('htmlContent').value;
                quill.root.innerHTML = htmlContent;
            } else {
                visualEditor.classList.add('hidden');
                htmlEditor.classList.remove('hidden');
                htmlBtn.classList.add('text-white', 'bg-purple-600');
                htmlBtn.classList.remove('text-gray-600', 'bg-gray-200', 'dark:bg-gray-600', 'dark:text-gray-300');
                visualBtn.classList.remove('text-white', 'bg-purple-600');
                visualBtn.classList.add('text-gray-600', 'bg-gray-200', 'dark:bg-gray-600', 'dark:text-gray-300');

                // Sync Quill to HTML
                document.getElementById('htmlContent').value = quill.root.innerHTML;
            }
        }

        // Handle HTML editor changes
        document.getElementById('htmlContent')?.addEventListener('input', function() {
            document.getElementById('bodyInput').value = this.value;
            document.getElementById('sendBodyInput').value = this.value;
            document.getElementById('scheduleBodyInput').value = this.value;
        });

        function openScheduleModal() {
            syncContent();
            document.getElementById('scheduleModal').classList.remove('hidden');
            document.getElementById('scheduleModal').classList.add('flex');
        }

        function closeScheduleModal() {
            document.getElementById('scheduleModal').classList.add('hidden');
            document.getElementById('scheduleModal').classList.remove('flex');
        }

        function confirmSend() {
            if (confirm('Send this campaign now? This action cannot be undone.')) {
                syncContent();
                document.getElementById('sendForm').submit();
            }
        }

        function openPreviewModal() {
            syncContent();
            const fromName = document.querySelector('[name="Input.FromName"]').value || 'Your Store';
            const fromEmail = document.querySelector('[name="Input.FromEmail"]').value || 'hello@yourstore.com';
            const subject = document.querySelector('[name="Input.Subject"]').value || 'No subject';
            const body = document.getElementById('bodyInput').value || '<p>No content</p>';

            document.getElementById('previewFrom').textContent = `${fromName} <${fromEmail}>`;
            document.getElementById('previewSubject').textContent = subject;
            document.getElementById('previewBody').innerHTML = body;

            document.getElementById('previewModal').classList.remove('hidden');
            document.getElementById('previewModal').classList.add('flex');
        }

        function closePreviewModal() {
            document.getElementById('previewModal').classList.add('hidden');
            document.getElementById('previewModal').classList.remove('flex');
        }

        // Close modals on escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeScheduleModal();
                closePreviewModal();
            }
        });
    </script>
}
